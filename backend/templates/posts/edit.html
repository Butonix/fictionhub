{% extends "base.html" %}
{% load markdownify %}
{% load title %}
{% load static %}

{% block content %}

<div class="container">
  <div class="row edit">
    <div class="col-xs-12">
      <div class="editor">
	{{form.errors}}
	<!-- Submit Form -->
	<form
	   {% if post %}
	   action="{{post.get_absolute_url}}edit"
	   {% else %}
	   action="/create?{{request.GET.urlencode}}"
	   {% endif %}	   
	   method="post">{% csrf_token %}

	  <!-- Chapters	-->
	  <div class="chapters">
	    {% if post.series %}
	    <!-- If post already has series, create chapter under this series. -->
	    <a class="btn btn-default"
	       href="/write?series={{post.series.pk}}">
		Add Chapter
	    </a>
	    {% elif post %}
	    <!-- If not - create new series, and add this post to it. -->
	    <a class="btn btn-default"
	       href="/write?series=new&post={{post.slug}}">
		Add Chapter
	    </a>
	    {% else %}	  	       	    	    
	    <!-- If I'm writing a new post - don't show the button. -->
	    {% endif %}	  	       	    

	    <!-- If it's a part of the Series, show other chapters -->
	    {% if post.series %}	  
	    <div class="dropdown">
	      <span class="btn btn-default chapter-title">
		<!-- Chapter title. Removed markdown. -->
		{{post|title|striptags}}
	      </span>
	      <ul class="dropdown-menu" role="menu">
		{% for child in post.series.chapters.all %}	  	      
		<li>
		  <a href="{{child.get_absolute_url}}edit"
		     {% if child == post %}
		     class="active"
		     {% endif %}>
		    {{ forloop.counter }}.
		    {{child|markdownify|striptags|truncatechars:30}}		    
		  </a>
		</li>
		{% endfor %}	  	      
	      </ul>
	    </div>
	    {% endif %}	  
	  </div>


	  <!-- Editor Body -->
	  {{form.body}}
	  
	  <!-- Category -->
          <div class="col-xs-12 col-sm-3">
	    <select name="post_category" class="form-control">
	      <option value="">Category</option>
	      {% for category in categories %}
	      <option value="{{category.slug}}"
		      {% if category == post.category %}selected{% endif %}
		      >{{category.title}}</option>
	      {% endfor %}
	    </select>
	  </div>

	  <!-- Tags -->
          <div class="col-xs-12 col-sm-9">
            <input type="text" class="form-control"
		   name="tags" placeholder="Tags (SciFi, Comedy, Fanfiction)"
		   value="{{post_tags}}">
          </div>



	  <!-- Buttons -->
          <div class="clearfix"></div><br/>
	  <div>
	    {% if post %}
	    <div class="left">
	      <a data-toggle="modal" data-target="#delete" 
		 class="btn btn-danger">
		Delete
	      </a>
	    </div>
	    {% endif %}

	    <div class="right">
	      {% if post %}
	      <a class="btn btn-primary" href="{{post.get_absolute_url}}">
		View
	      </a>

	      {% if not post.published %}
	      <a class="btn btn-primary" href="{{post.get_absolute_url}}publish">
		Publish
	      </a>
	      {% else %}
	      <a class="btn btn-primary" href="{{post.get_absolute_url}}unpublish">
		Un-Publish
	      </a>	      
	      {% endif %}
	      
	      {% endif %} <!-- end if post -->
	      <button class="btn btn-primary" type="submit">
		Save
	      </button>
	    </div>
	  </div> <!-- End col-xs-12 (buttons) -->
	  
	</form>
      </div> <!-- End .editor -->
    </div>   <!-- End .col-sm-12 -->
  </div> <!-- End .row .edit -->
</div> <!-- End .container -->





<div id="delete" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <!-- <button type="button" class="close" data-dismiss="modal">&times;</button> -->
      <div class="modal-body">
	<p>Are you sure you want to delete the post?</p>
	<a href="{{post.get_absolute_url}}delete"
	   class="btn btn-danger right">
	  Delete
	</a>
        <button class="btn btn-default right margins-h-10" data-dismiss="modal">
	  Cancel
	</button>
	<div class="clearfix"></div>
      </div> <!-- End .modal-body -->
    </div> <!-- End .modal-content -->
  </div> <!-- End .modal-dialog -->
</div>	 <!-- End .modal -->

<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script src="{% static "/js/editor.js" %}"></script>


{% endblock %}
